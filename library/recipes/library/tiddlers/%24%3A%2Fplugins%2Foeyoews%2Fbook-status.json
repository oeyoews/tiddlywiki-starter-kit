{"title":"$:/plugins/oeyoews/book-status","description":"book-status","author":"oeyoews","version":"0.4.0","core-version":">=5.3.1","type":"application/json","plugin-type":"plugin","name":"book-status","meat#disabled":"yes","dependents":"$:/plugins/oeyoews/notify $:/plugins/oeyoews/neotw-icons $:/plugins/oeyoews/nprogress","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/book-status/readme\":{\"title\":\"$:/plugins/oeyoews/book-status/readme\",\"text\":\"## book status\\n\\n> https://github.com/oeyoews/reading-books-with-tiddlywiki\\n\\n记录你读过的每一个笔记 (此插件针对上述链接的项目)\\n\\n## TODO\\n\\n- [x] 在每个目录旁边显示是否阅读过，bingo/x\\n- [x] 获取目录 json 数据\\n- [x] getstorytiddler\\n- [x] click event\\n- [x] status json\\n- [x] 如何获取每个笔记的书名，通过 sourceTiddler, 或者获取 tag, 每本书只有一个 tag\\n- [x] viewtemplate(filter: $:/plugins/books/) 也许可以做成 viewtoolbar, 但是不够醒目\\n- [x] 也许可以借助 localstorage 当作临时状态 (), 最后结束是，询问是否要保存此次阅读记录，通知阅读时间\\n- [x] 支持待看状态\\n- [x] 每本书一个配置文件，目前是一个文件\\n\",\"type\":\"text/markdown\",\"description\":\"book-status\"},\"$:/plugins/oeyoews/book-status/icon\":{\"title\":\"$:/plugins/oeyoews/book-status/icon\",\"type\":\"image/svg+xml\",\"text\":\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"128\\\" height=\\\"128\\\" viewBox=\\\"0 0 128 128\\\"><defs><path id=\\\"notoBookmarkTabs0\\\" fill=\\\"#FFF\\\" d=\\\"M95.86 114.13H18.05c-2.21 0-4-1.79-4-4V8c0-2.21 1.79-4 4-4h77.81c2.21 0 4 1.79 4 4v102.13c0 2.21-1.79 4-4 4z\\\"/></defs><path fill=\\\"#FFF\\\" d=\\\"M106.75 123.88H32.94c-2.21 0-4-1.79-4-4V14.79c0-2.21 1.79-4 4-4h73.82c2.21 0 4 1.79 4 4v105.09c-.01 2.21-1.8 4-4.01 4z\\\"/><path fill=\\\"#6FBFF0\\\" d=\\\"M106.75 10.79h-6.89v3h6.89c.55 0 1 .45 1 1v105.09c0 .55-.45 1-1 1H32.94c-.55 0-1-.45-1-1v-5.75h-3v5.75c0 2.21 1.79 4 4 4h73.82c2.21 0 4-1.79 4-4V14.79c-.01-2.2-1.8-4-4.01-4z\\\"/><use href=\\\"#notoBookmarkTabs0\\\"/><path fill=\\\"#FFD54F\\\" d=\\\"M117.95 52.62c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H96.84c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#F3AB47\\\" d=\\\"M117.35 42.11c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H96.84c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.6-1.16z\\\"/><path fill=\\\"#0091EA\\\" d=\\\"M117.95 95.16c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H96.84c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#01579B\\\" d=\\\"M117.35 84.64c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H96.84c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33V85.8c0-.42-.23-.89-.6-1.16z\\\"/><path fill=\\\"#212121\\\" d=\\\"M17.13 10.79c-.01.09 11.05.17 11.05.26l.76 27.79v78.34h69.98c2.21 0 4-1.79 4-4V11.05c0-.09-.02-.17-.03-.26H17.13z\\\" opacity=\\\".25\\\"/><use href=\\\"#notoBookmarkTabs0\\\"/><path fill=\\\"#6FBFF0\\\" d=\\\"M95.86 7c.55 0 1 .45 1 1v102.13c0 .55-.45 1-1 1H18.05c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1h77.81m0-3H18.05c-2.21 0-4 1.79-4 4v102.13c0 2.21 1.79 4 4 4h77.81c2.21 0 4-1.79 4-4V8c0-2.21-1.79-4-4-4z\\\"/><path fill=\\\"none\\\" stroke=\\\"#B0BEC5\\\" stroke-linecap=\\\"round\\\" stroke-miterlimit=\\\"10\\\" stroke-width=\\\"3.865\\\" d=\\\"M27.11 30.48h57.11M27.11 44.25h57.11M27.11 58.03h57.11M27.11 71.81h57.11M27.11 85.58h24.43\\\"/><path fill=\\\"#F44336\\\" d=\\\"M116.09 33.46c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H94.98c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#9CCC65\\\" d=\\\"M116.09 76c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H94.98c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33V76z\\\"/><path fill=\\\"#C62828\\\" d=\\\"M115.5 22.96c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H94.98c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.59-1.16z\\\"/><path fill=\\\"#7CB342\\\" d=\\\"M115.5 65.48c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H94.98c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.59-1.16z\\\"/></svg>\"},\"$:/plugins/oeyoews/book-status/mergeObj.js\":{\"title\":\"$:/plugins/oeyoews/book-status/mergeObj.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/mergeObj.js\\ntype: application/javascript\\nmodule-type: library\\n\\n\\\\*/\\n// TODO: Object.assign\\nmodule.exports = function mergeObjects(target, ...sources) {\\n  for (const source of sources) {\\n    for (const key in source) {\\n      if (source.hasOwnProperty(key)) {\\n        if (typeof source[key] === 'object' && !Array.isArray(source[key])) {\\n          // 如果属性值是对象，则递归地合并子对象\\n          if (!target.hasOwnProperty(key) || typeof target[key] !== 'object') {\\n            target[key] = {};\\n          }\\n          mergeObjects(target[key], source[key]);\\n        } else {\\n          // 否则直接复制属性值\\n          target[key] = source[key];\\n        }\\n      }\\n    }\\n  }\\n  return target;\\n};\\n\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/book-status/style\":{\"title\":\"$:/plugins/oeyoews/book-status/style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\"#om-progress {\\n  height: 10px;\\n  width: 100%;\\n  border-radius: 9px;\\n  overflow: hidden;\\n  -webkit-appearance: none;\\n  appearance: none;\\n}\\n\\n#om-progress::-webkit-progress-bar {\\n  background-color: #efefef;\\n}\\n\\n#om-progress::-webkit-progress-value {\\n  background: linear-gradient(135deg, #12c2e9, #ffafbd, #c9ffbf);\\n  animation: progress-bar 1s ease-out infinite;\\n}\\n\\n@keyframes progress-bar {\\n  0% {\\n    box-shadow: 0 0 1px #007aff;\\n  }\\n  50% {\\n    box-shadow: 0 0 2px #007aff;\\n  }\\n  100% {\\n    box-shadow: 0 0 1px #007aff;\\n  }\\n}\\n\"},\"$:/plugins/oeyoews/book-status/tocstatus.js\":{\"title\":\"$:/plugins/oeyoews/book-status/tocstatus.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/tocstatus.js\\ntype: application/javascript\\nmodule-type: widget\\n\\n使用 wikitext 应该也能做，但是数据在 json 里面，比较麻烦\\n\\\\*/\\nconst { widget: Widget } = require('$:/core/modules/widgets/widget.js');\\n\\nclass BookTocStatusWidget extends Widget {\\n  constructor(parseTreeNode, options) {\\n    super(parseTreeNode, options);\\n  }\\n\\n  render(parent, nextSibling) {\\n    if (!$tw.browser) return;\\n    this.parentDomNode = parent;\\n    this.computeAttributes();\\n    this.execute();\\n\\n    const { bookname = '劫持' } = this.attributes;\\n    const wiki = $tw.wiki;\\n    const createElement = $tw.utils.domMaker;\\n    const statusfilename = 'bookstatus.json';\\n    const statuses = wiki.getTiddlerData(statusfilename);\\n    const pluginname = '$:/plugins/books/' + bookname;\\n    if (!wiki.tiddlerExists(pluginname)) return;\\n    const { tiddlers } = wiki.getPluginInfo(pluginname);\\n    const toc = Object.keys(tiddlers)\\n      .filter((title) => !title.startsWith('$:/'))\\n      .map((title) => ({\\n        title,\\n        status: '未读'\\n      }));\\n    const readlist =\\n      statuses?.[bookname] &&\\n      Object.entries(statuses?.[bookname]).map(([title, status]) => ({\\n        title,\\n        status\\n      }));\\n    const tocstatuslist = new Map();\\n\\n    toc.forEach(({ title, status }) => {\\n      tocstatuslist.set(title, status);\\n    });\\n    let readcount = 0;\\n    readlist?.forEach(({ title, status }) => {\\n      status === '已读' && readcount++;\\n      tocstatuslist.set(title, status);\\n    });\\n    const progressvalue = (readcount / toc.length) * 100;\\n    const statusprogress = progressvalue.toFixed(2);\\n\\n    const children = [];\\n\\n    // update status\\n    const createLi = (title, status) => {\\n      const li = this.document.createElement('li');\\n      const color = status === '已读' ? 'green' : 'red';\\n      const icon = status === '已读' ? 'emojione-v1:left-check-mark' : '未读';\\n      const content = $tw.wiki.renderText(\\n        'text/html',\\n        'text/vnd.tiddlywiki',\\n        `[[${title}]]\\n<% if [[$:/plugins/oeyoews/neotw-icons]has[plugin-type]] %>\\n  <$iconify icon=${icon} />\\n<% endif %>\\n<sup>@@color:${color};font-size:10px;${status}@@</sup>`\\n      );\\n      li.innerHTML = content;\\n      children.push(li);\\n      li.addEventListener('click', (e) => {\\n        const progress = $tw.NProgress;\\n        progress.start();\\n        e.preventDefault();\\n        new $tw.Story().navigateTiddler(title);\\n        progress.done();\\n      });\\n    };\\n\\n    tocstatuslist.forEach((status, title) => {\\n      createLi(title, status);\\n    });\\n\\n    const progressNode = createElement('progress', {\\n      attributes: {\\n        id: 'om-progress',\\n        value: progressvalue,\\n        max: 100\\n      }\\n    });\\n\\n    const statusprogressNode = createElement('center', {\\n      text: `${bookname} 阅读进度：${statusprogress}%`\\n    });\\n    children.unshift(statusprogressNode);\\n    children.unshift(progressNode);\\n\\n    const domNode = createElement('ol', {\\n      children\\n    });\\n\\n    parent.insertBefore(domNode, nextSibling);\\n    this.domNodes.push(domNode);\\n  }\\n  refresh(changedTiddlers) {\\n    if (Object.keys(changedTiddlers).includes('bookstatus.json')) {\\n      this.refreshSelf();\\n      return true;\\n    } else {\\n      return false;\\n    }\\n  }\\n}\\n\\n/**\\n * @description book-status widget\\n * @param bookname\\n */\\nexports.tocstatus = BookTocStatusWidget;\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"},\"$:/plugins/oeyoews/book-status/viewTemplate\":{\"title\":\"$:/plugins/oeyoews/book-status/viewTemplate\",\"tags\":\"$:/tags/ViewTemplate\",\"text\":\"<$list filter=\\\"[all[current]is[shadow]has[bookname]]\\\">\\r\\n  <$bookstatus />\\r\\n</$list>\\r\\n\"},\"$:/plugins/oeyoews/book-status/widget.js\":{\"title\":\"$:/plugins/oeyoews/book-status/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nbook-status widget\\n\\n\\\\*/\\nconst { widget: Widget } = require('$:/core/modules/widgets/widget.js');\\nconst mergeObj = require('./mergeObj');\\n\\nclass BookStatusWidget extends Widget {\\n  static STATUS_UNREAD = '未读';\\n  static STATUS_READ = '已读';\\n\\n  constructor(parseTreeNode, options) {\\n    super(parseTreeNode, options);\\n    this.bookstatusfilename = 'bookstatus.json';\\n    this.statuses = new Map();\\n    this.btn;\\n  }\\n\\n  readStatuses() {\\n    const config = $tw.wiki.getTiddlerData(this.bookstatusfilename) || {};\\n    // json 对象转 Map\\n    Object.entries(config).forEach(([bookname, book]) => {\\n      Object.entries(book).forEach(([title, status]) => {\\n        const key = `${bookname}/${title}`;\\n        this.statuses.set(key, status);\\n      });\\n    });\\n  }\\n\\n  // 当需要获取某个书籍的阅读状态时，会先从 Map 中查找，如果没有找到则从配置文件中读取数据并进行解析，\\n  // 然后将结果存入 Map 中以备下次使用。\\n  getStatus(bookname, title) {\\n    const key = `${bookname}/${title}`;\\n    if (!this.statuses.has(key)) {\\n      this.readStatuses();\\n    }\\n    return this.statuses.get(key) || '未读';\\n  }\\n\\n  updateStatus(bookname, title) {\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-nprogress'\\n    });\\n    if (title.startsWith('Draft of') || !bookname) return;\\n    const wiki = $tw.wiki;\\n\\n    const defaultconfig = wiki.getTiddlerData(this.bookstatusfilename) || {};\\n    if (!wiki.tiddlerExists(this.bookstatusfilename)) {\\n      wiki.addTiddler({\\n        type: 'application/json',\\n        title: this.bookstatusfilename,\\n        'meta#disabled': 'yes', // disable meta file\\n        text: ''\\n      });\\n    }\\n    const key = `${bookname}/${title}`;\\n    const status = this.getStatus(bookname, title);\\n    const newStatus =\\n      status === BookStatusWidget.STATUS_READ\\n        ? BookStatusWidget.STATUS_UNREAD\\n        : BookStatusWidget.STATUS_READ;\\n    this.statuses.set(key, newStatus);\\n    const obj = {\\n      [bookname]: {\\n        [title]: newStatus\\n      }\\n    };\\n    mergeObj(defaultconfig, obj);\\n    wiki.setText(\\n      this.bookstatusfilename,\\n      'text',\\n      null,\\n      JSON.stringify(defaultconfig),\\n      {\\n        suppressTimestamp: true\\n      }\\n    );\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-notify',\\n      paramObject: {\\n        status: newStatus === BookStatusWidget.STATUS_READ ? 'success' : 'info',\\n        title,\\n        text: `更新状态：${newStatus}`\\n      }\\n    });\\n    this.btn.removeEventListener('click', () =>\\n      this.updateStatus(bookname, title)\\n    );\\n    this.refreshSelf();\\n    this.parentWidget.dispatchEvent({\\n      type: 'om-nprogress-done'\\n    });\\n  }\\n\\n  render(parent, nextSibling) {\\n    if (!$tw.browser) return;\\n    this.parentDomNode = parent;\\n    this.computeAttributes();\\n    this.execute();\\n\\n    const createElement = $tw.utils.domMaker;\\n    const wiki = $tw.wiki;\\n    const title = this.getVariable('storyTiddler');\\n    const pluginname = wiki.getShadowSource(title);\\n    const { book: bookname } = wiki.getTiddler(pluginname)?.fields || {};\\n    const status = this.getStatus(bookname, title);\\n\\n    const statusClass =\\n      status === BookStatusWidget.STATUS_READ\\n        ? 'text-green-400'\\n        : 'text-rose-400';\\n    this.btn = createElement('button', {\\n      text: status,\\n      class: `p-2 ${statusClass}`\\n    });\\n\\n    this.btn.addEventListener('click', () =>\\n      this.updateStatus(bookname, title)\\n    );\\n\\n    const domNode = createElement('div', {\\n      class: 'flex justify-end',\\n      children: [this.btn]\\n    });\\n\\n    parent.insertBefore(domNode, nextSibling);\\n    this.domNodes.push(domNode);\\n  }\\n}\\n\\n/**\\n * @description book-status widget\\n * @param configfilename\\n */\\nexports.bookstatus = BookStatusWidget;\\n\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}