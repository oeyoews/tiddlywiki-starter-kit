{"title":"$:/plugins/oeyoews/book-status","description":"book-status","author":"oeyoews","version":"0.4.0","core-version":">=5.3.1","type":"application/json","plugin-type":"plugin","name":"book-status","meat#disabled":"yes","dependents":"$:/plugins/oeyoews/notify $:/plugins/oeyoews/neotw-icons $:/plugins/oeyoews/nprogress","list":"readme","text":"{\"tiddlers\":{\"$:/plugins/oeyoews/book-status/readme\":{\"title\":\"$:/plugins/oeyoews/book-status/readme\",\"text\":\"## book status\\n\\n> https://github.com/oeyoews/reading-books-with-tiddlywiki\\n\\n记录你读过的每一个笔记 (此插件针对上述链接的项目)\\n\\n## TODO\\n\\n- [x] 在每个目录旁边显示是否阅读过，bingo/x\\n- [x] 获取目录 json 数据\\n- [x] getstorytiddler\\n- [x] click event\\n- [x] status json\\n- [x] 如何获取每个笔记的书名，通过 sourceTiddler, 或者获取 tag, 每本书只有一个 tag\\n- [x] viewtemplate(filter: $:/plugins/books/) 也许可以做成 viewtoolbar, 但是不够醒目\\n- [x] 也许可以借助 localstorage 当作临时状态 (), 最后结束是，询问是否要保存此次阅读记录，通知阅读时间\\n- [x] 支持待看状态\\n- [x] 每本书一个配置文件，目前是一个文件\\n\",\"type\":\"text/markdown\",\"description\":\"book-status\"},\"$:/plugins/oeyoews/book-status/icon\":{\"title\":\"$:/plugins/oeyoews/book-status/icon\",\"type\":\"image/svg+xml\",\"text\":\"<svg xmlns=\\\"http://www.w3.org/2000/svg\\\" width=\\\"128\\\" height=\\\"128\\\" viewBox=\\\"0 0 128 128\\\"><defs><path id=\\\"notoBookmarkTabs0\\\" fill=\\\"#FFF\\\" d=\\\"M95.86 114.13H18.05c-2.21 0-4-1.79-4-4V8c0-2.21 1.79-4 4-4h77.81c2.21 0 4 1.79 4 4v102.13c0 2.21-1.79 4-4 4z\\\"/></defs><path fill=\\\"#FFF\\\" d=\\\"M106.75 123.88H32.94c-2.21 0-4-1.79-4-4V14.79c0-2.21 1.79-4 4-4h73.82c2.21 0 4 1.79 4 4v105.09c-.01 2.21-1.8 4-4.01 4z\\\"/><path fill=\\\"#6FBFF0\\\" d=\\\"M106.75 10.79h-6.89v3h6.89c.55 0 1 .45 1 1v105.09c0 .55-.45 1-1 1H32.94c-.55 0-1-.45-1-1v-5.75h-3v5.75c0 2.21 1.79 4 4 4h73.82c2.21 0 4-1.79 4-4V14.79c-.01-2.2-1.8-4-4.01-4z\\\"/><use href=\\\"#notoBookmarkTabs0\\\"/><path fill=\\\"#FFD54F\\\" d=\\\"M117.95 52.62c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H96.84c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#F3AB47\\\" d=\\\"M117.35 42.11c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H96.84c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.6-1.16z\\\"/><path fill=\\\"#0091EA\\\" d=\\\"M117.95 95.16c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H96.84c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#01579B\\\" d=\\\"M117.35 84.64c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H96.84c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33V85.8c0-.42-.23-.89-.6-1.16z\\\"/><path fill=\\\"#212121\\\" d=\\\"M17.13 10.79c-.01.09 11.05.17 11.05.26l.76 27.79v78.34h69.98c2.21 0 4-1.79 4-4V11.05c0-.09-.02-.17-.03-.26H17.13z\\\" opacity=\\\".25\\\"/><use href=\\\"#notoBookmarkTabs0\\\"/><path fill=\\\"#6FBFF0\\\" d=\\\"M95.86 7c.55 0 1 .45 1 1v102.13c0 .55-.45 1-1 1H18.05c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1h77.81m0-3H18.05c-2.21 0-4 1.79-4 4v102.13c0 2.21 1.79 4 4 4h77.81c2.21 0 4-1.79 4-4V8c0-2.21-1.79-4-4-4z\\\"/><path fill=\\\"none\\\" stroke=\\\"#B0BEC5\\\" stroke-linecap=\\\"round\\\" stroke-miterlimit=\\\"10\\\" stroke-width=\\\"3.865\\\" d=\\\"M27.11 30.48h57.11M27.11 44.25h57.11M27.11 58.03h57.11M27.11 71.81h57.11M27.11 85.58h24.43\\\"/><path fill=\\\"#F44336\\\" d=\\\"M116.09 33.46c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H94.98c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33v9.32z\\\"/><path fill=\\\"#9CCC65\\\" d=\\\"M116.09 76c0 .63-.38 1.18-.93 1.33c-1.39.37-4.25.98-8 .98H94.98c-.48 0-.95-.19-1.32-.55l-4.07-3.89c-.96-.92-.96-2.59 0-3.51l4.07-3.89c.37-.35.84-.55 1.32-.55h15.53c1.58 0 3.06-.3 4.1-.57c.76-.2 1.49.45 1.49 1.33V76z\\\"/><path fill=\\\"#C62828\\\" d=\\\"M115.5 22.96c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H94.98c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.59-1.16z\\\"/><path fill=\\\"#7CB342\\\" d=\\\"M115.5 65.48c-.1-.07-.21-.13-.33-.16c-.01 2.02-.07 4.04-.07 6.06v4.6c0 .2-.11.34-.18.36c-1.33.36-4.11.95-7.75.95H94.98c-.22 0-.45-.1-.63-.27l-3.48-3.33c-.52-.5-1.06-.94-1.37-1.62c-.19-.43-.28-.91-.22-1.38c-.01.11-.16.26-.2.37c-.05.12-.08.26-.12.38c-.07.27-.1.56-.08.84c.04.58.28 1.15.71 1.56l4.07 3.89c.37.35.84.55 1.32.55h12.18c3.75 0 6.61-.61 8-.98c.55-.15.93-.7.93-1.33v-9.33c0-.42-.23-.9-.59-1.16z\\\"/></svg>\"},\"$:/plugins/oeyoews/book-status/mergeObj.js\":{\"title\":\"$:/plugins/oeyoews/book-status/mergeObj.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/mergeObj.js\\ntype: application/javascript\\nmodule-type: library\\n\\n\\\\*/\\nmodule.exports=function o(r,...t){for(const e of t)for(const t in e)e.hasOwnProperty(t)&&(\\\"object\\\"!=typeof e[t]||Array.isArray(e[t])?r[t]=e[t]:(r.hasOwnProperty(t)&&\\\"object\\\"==typeof r[t]||(r[t]={}),o(r[t],e[t])));return r};\",\"type\":\"application/javascript\",\"module-type\":\"library\"},\"$:/plugins/oeyoews/book-status/style\":{\"title\":\"$:/plugins/oeyoews/book-status/style\",\"tags\":\"$:/tags/Stylesheet\",\"type\":\"text/css\",\"text\":\"#om-progress {\\n  height: 10px;\\n  width: 100%;\\n  border-radius: 9px;\\n  overflow: hidden;\\n  -webkit-appearance: none;\\n  appearance: none;\\n}\\n\\n#om-progress::-webkit-progress-bar {\\n  background-color: #efefef;\\n}\\n\\n#om-progress::-webkit-progress-value {\\n  background: linear-gradient(135deg, #12c2e9, #ffafbd, #c9ffbf);\\n  animation: progress-bar 1s ease-out infinite;\\n}\\n\\n@keyframes progress-bar {\\n  0% {\\n    box-shadow: 0 0 1px #007aff;\\n  }\\n  50% {\\n    box-shadow: 0 0 2px #007aff;\\n  }\\n  100% {\\n    box-shadow: 0 0 1px #007aff;\\n  }\\n}\\n\"},\"$:/plugins/oeyoews/book-status/tocstatus.js\":{\"title\":\"$:/plugins/oeyoews/book-status/tocstatus.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/tocstatus.js\\ntype: application/javascript\\nmodule-type: widget\\n\\n使用 wikitext 应该也能做，但是数据在 json 里面，比较麻烦\\n\\\\*/\\nconst{widget:t}=require(\\\"$:/core/modules/widgets/widget.js\\\");exports.tocstatus=class extends t{constructor(t,e){super(t,e)}render(t,e){if(!$tw.browser)return;this.parentDomNode=t,this.computeAttributes(),this.execute();const{bookname:s=\\\"劫持\\\"}=this.attributes,i=$tw.wiki,r=$tw.utils.domMaker,n=i.getTiddlerData(\\\"bookstatus.json\\\"),o=\\\"$:/plugins/books/\\\"+s;if(!i.tiddlerExists(o))return;const{tiddlers:c}=i.getPluginInfo(o),u=Object.keys(c).filter((t=>!t.startsWith(\\\"$:/\\\"))).map((t=>({title:t,status:\\\"未读\\\"}))),a=n?.[s]&&Object.entries(n?.[s]).map((([t,e])=>({title:t,status:e}))),d=new Map;u.forEach((({title:t,status:e})=>{d.set(t,e)}));let l=0;a?.forEach((({title:t,status:e})=>{\\\"已读\\\"===e&&l++,d.set(t,e)}));const h=l/u.length*100,f=h.toFixed(2),p=[],w=(t,e)=>{const s=this.document.createElement(\\\"li\\\"),i=\\\"已读\\\"===e?\\\"green\\\":\\\"red\\\",r=\\\"已读\\\"===e?\\\"emojione-v1:left-check-mark\\\":\\\"未读\\\",n=$tw.wiki.renderText(\\\"text/html\\\",\\\"text/vnd.tiddlywiki\\\",`[[${t}]]\\\\n<% if [[$:/plugins/oeyoews/neotw-icons]has[plugin-type]] %>\\\\n  <$iconify icon=${r} />\\\\n<% endif %>\\\\n<sup>@@color:${i};font-size:10px;${e}@@</sup>`);s.innerHTML=n,p.push(s),s.addEventListener(\\\"click\\\",(e=>{const s=$tw.NProgress;s.start(),e.preventDefault(),(new $tw.Story).navigateTiddler(t),s.done()}))};d.forEach(((t,e)=>{w(e,t)}));const $=r(\\\"progress\\\",{attributes:{id:\\\"om-progress\\\",value:h,max:100}}),g=r(\\\"center\\\",{text:`${s} 阅读进度：${f}%`});p.unshift(g),p.unshift($);const m=r(\\\"ol\\\",{children:p});t.insertBefore(m,e),this.domNodes.push(m)}refresh(t){return!!Object.keys(t).includes(\\\"bookstatus.json\\\")&&(this.refreshSelf(),!0)}};\",\"type\":\"application/javascript\",\"module-type\":\"widget\"},\"$:/plugins/oeyoews/book-status/viewTemplate\":{\"title\":\"$:/plugins/oeyoews/book-status/viewTemplate\",\"tags\":\"$:/tags/ViewTemplate\",\"text\":\"<$list filter=\\\"[all[current]is[shadow]has[bookname]]\\\">\\r\\n  <$bookstatus />\\r\\n</$list>\\r\\n\"},\"$:/plugins/oeyoews/book-status/widget.js\":{\"title\":\"$:/plugins/oeyoews/book-status/widget.js\",\"text\":\"/*\\\\\\ntitle: $:/plugins/oeyoews/book-status/widget.js\\ntype: application/javascript\\nmodule-type: widget\\n\\nbook-status widget\\n\\n\\\\*/\\nconst{widget:t}=require(\\\"$:/core/modules/widgets/widget.js\\\"),s=require(\\\"./mergeObj\\\");class e extends t{static STATUS_UNREAD=\\\"未读\\\";static STATUS_READ=\\\"已读\\\";constructor(t,s){super(t,s),this.bookstatusfilename=\\\"bookstatus.json\\\",this.statuses=new Map,this.btn}readStatuses(){const t=$tw.wiki.getTiddlerData(this.bookstatusfilename)||{};Object.entries(t).forEach((([t,s])=>{Object.entries(s).forEach((([s,e])=>{const i=`${t}/${s}`;this.statuses.set(i,e)}))}))}getStatus(t,s){const e=`${t}/${s}`;return this.statuses.has(e)||this.readStatuses(),this.statuses.get(e)||\\\"未读\\\"}updateStatus(t,i){if(this.parentWidget.dispatchEvent({type:\\\"om-nprogress\\\"}),i.startsWith(\\\"Draft of\\\")||!t)return;const a=$tw.wiki,r=a.getTiddlerData(this.bookstatusfilename)||{};a.tiddlerExists(this.bookstatusfilename)||a.addTiddler({type:\\\"application/json\\\",title:this.bookstatusfilename,\\\"meta#disabled\\\":\\\"yes\\\",text:\\\"\\\"});const o=`${t}/${i}`,n=this.getStatus(t,i)===e.STATUS_READ?e.STATUS_UNREAD:e.STATUS_READ;this.statuses.set(o,n),s(r,{[t]:{[i]:n}}),a.setText(this.bookstatusfilename,\\\"text\\\",null,JSON.stringify(r),{suppressTimestamp:!0}),this.parentWidget.dispatchEvent({type:\\\"om-notify\\\",paramObject:{status:n===e.STATUS_READ?\\\"success\\\":\\\"info\\\",title:i,text:`更新状态：${n}`}}),this.btn.removeEventListener(\\\"click\\\",(()=>this.updateStatus(t,i))),this.refreshSelf(),this.parentWidget.dispatchEvent({type:\\\"om-nprogress-done\\\"})}render(t,s){if(!$tw.browser)return;this.parentDomNode=t,this.computeAttributes(),this.execute();const i=$tw.utils.domMaker,a=$tw.wiki,r=this.getVariable(\\\"storyTiddler\\\"),o=a.getShadowSource(r),{book:n}=a.getTiddler(o)?.fields||{},d=this.getStatus(n,r),u=d===e.STATUS_READ?\\\"text-green-400\\\":\\\"text-rose-400\\\";this.btn=i(\\\"button\\\",{text:d,class:`p-2 ${u}`}),this.btn.addEventListener(\\\"click\\\",(()=>this.updateStatus(n,r)));const h=i(\\\"div\\\",{class:\\\"flex justify-end\\\",children:[this.btn]});t.insertBefore(h,s),this.domNodes.push(h)}}exports.bookstatus=e;\",\"type\":\"application/javascript\",\"module-type\":\"widget\"}}}"}